# 2021元宵节线上灯谜PK活动后端接口文档

| 历史版本号      | 日期      | 制定人 | 内容说明 |
| ------------- | --------- | ----- | ------ |
| 1.0（当前版本） | 2021.1.26 | 叶郅祺 | 初始版本 |

## 1. 接口模块说明、设计总体说明

根据需求文档，分别设计了如下接口模块：

+ 统一认证登录模块
+ 单人闯关答题模块
+ 双人pk模块（创建房间、答题）
+ 信息获取模块（答题情况记录，等等）
+ 管理模块（需要以管理员身份登录）

以下是关于接口调用的一些统一约定：

1. 统一的协议：

   均以https协议调用。

2. 统一的请求格式：

   + 请求行：路径名称、参数名称都大小写敏感，注意不要写错。
   + 请求头：
     + `Token`：除了登录接口，其他接口都需要在请求的header通过自定义字段`Token`来发送token内容（关于token的说明详见登录接口），如请求头有`Token: wkq5z0ti49dvmkrs`这样一行。
     + `Content-Type`：如果用POST方法向服务器请求，那么设其为`application/x-www-form-urlencoded;charset=UTF-8`来传键值对（`multipart/form-data`传二进制文件在本项目中没有用到）。
   + 请求体：暂无约定。

3. 统一的返回格式：

   + 用JSON格式返回，返回的的`content-type`设为`application/json;charset=UTF-8`。
   + 返回标准的response对象，有`code`，`message`和`data`三项。  
     `code`为返回状态代码（一个整数），0代表成功，非0值代表出错。  
     `message`为一个字符串。如果没有出错，则`message`为`"success"`；如果出错，则`message`为错误的详细说明。  
     `data`为返回的数据对象，对象的各个字段是接口的各个返回值。如果出错，或接口没有返回值，则`data`为一个空对象`{}`。

   样例：

   ``` JSON
   {
       "code": 0,
       "message": "success",
       "data": {
           "token": "wkq5z0ti49dvmkrs"
       }
   }
   ```


接口总览：

| 模块  | URL    | 接口作用 | 调用方式      | 参数概览          | 返回值 |
| ------ | ------ | ----------------- | ------------ | ------------ | ------ |
| 登录 | /login |  登录，获取token  | POST | user_id, password | token        |
| 闯关+pk | /room/create | 创建一个房间 | POST | capacity | room_id |
| pk | /room/join | 加入一个房间 | POST | room_id |  |
| pk | /room/match | 匹配一个房间 | POST |  | room_id |
| 闯关+pk | /room/get_attribute | 获取房间各种属性 | POST | room_id | 一个Object |
| 闯关+pk | /room/ready | 发送答题就绪信号 | POST | room_id |  |
| 闯关+pk | /room/answer | 答题 | POST | room_id, num, ans | is_correct |
| 闯关+pk | /room/leave | 离开房间 | POST | room_id |  |
| 信息获取 | /info/ranking_list | 获取高分榜 | GET | [offset, limit] | ranking_list |

注：1. "answer"做动词时是answer，作名词时是ans。2. `/room`系列模块的URL命名都是`/room/一个动作`。

接口返回code总览：

| code | message                         |
| ---- | ------------------------------- |
| 0    | success                         |
| 1    | 调用本接口时没有带上合法的token   |
| 2    | 缺少必填参数                    |
| 3    | 参数类型错误                    |
| 100  | 用户在黑名单中，无法登录          |
| 200  | 无效的房间号                    |
| 201  | 用户不在该房间内                 |
| 210  | 房间不是unfull状态，无法加入      |
| 230 | 接口不在开放时间段内 |
| 231 | 匹配失败 |
| 260  | 房间状态不为playing              |
| 261  | 当前不应该回答第num道题           |
| 270  | 房间状态已经是terminated         |

code设计说明：0-9号通用错误，然后模块1为100-199，模块2为200-299，诸如此类。每个模块内，按照10为单位划分，比如模块通用错误为200-209，某一个接口的返回错误在210-219之间。

## 2. 登录模块

### 2.1 登录接口（/login）

接口URL：/login

接口详细说明：  
该接口用于用户登录，如果用户名正确、密码正确等等就可以从服务器获取token（令牌），后续调用其他接口时都需要在需要用到token。  
token是服务器生产的**一串用于身份验证的字符串**，有不同的实现。我们使用“随机字符串”这种方案，**约定token是长度为16的、由0-9和a-z组成的随机字符串**，如`"wkq5z0ti49dvmkrs"`、`"rofty43u64tbb030"`。服务器维护了每个token和用户直接的对应关系。每个token的有效期是2小时（由服务器维护），每次调用接口后服务器会把该token的“剩余有效时间”刷新为2小时。

调用方式：POST

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明 |
| -------- | ------ | ---- | -------- |
| user_id  | Number | 是   | 用户名   |
| password | String | 是   | 密码     |

注：这里不对用户信息进行加密，因为Https提供了初步的、这个业务所需的足够的安全性。

接口返回：

| code | message                  | data          | 说明               |
| ---- | ------------------------ | ------------- | ------------------ |
| 0    | success                  | token: String | token的语义见上    |
| 2    | 缺少必填参数             |               |                    |
| 3    | 参数类型错误             |               |                    |
| 100  | 用户在黑名单中，无法登录 |               | 黑名单由管理员添加 |

返回示例：

``` JSON
成功返回：
{
    "code": 0,
    "message": "success",
    "data": {
        "token": "wkq5z0ti49dvmkrs"
    }
}
```

## 3. 闯关+pk模块

经过了若干次尝试，终于找到了一种相对简洁的方式实现闯关+pk部分的接口，由于二者有很多相同的接口，所以就合并在一起写了。

首先是要引入房间（room）的概念。**房间是用户答题的“场所”**，分为单人房和双人房两种（没有三人房，也没有总统套房(￣▽￣)／），单人房用来闯关，双人房用来pk。**房间有各种属性（attribute），是对闯关/pk流程中各种状态的一种抽象**，比如有room_id，user1_id，user2_id，capacity，state等等，后面会单独列表给出，其中的一个重点属性就是**state（状态）**，它贯穿了整个房间的生命周期，后面会单独来讲一讲。

先来看room的来源。单人房的来源只有一种，即create，而双人房的来源有两种：一种是match直接得到一个满人的房间，房间的另一位选手就是队友；另外一种是邀请队友，先create一个capacity为2的房间，但是只有自己，然后邀请队友进入（join）房间。

然后来分析room在整个生命周期中的各种state了。**房间的state是一个字符串**，代表房间的一种状态。房间初始的状态可以是`"full"`或者`"unfull"`，如果是`"unfull"`的房间通过join可以变成`"full"`。房间满人后就等待各个成员开始确认，全员确认后，进入`"playing"`状态。答完题后是`"end"`状态，如果队员重新全部确认就可以再次进入`"playing"`状态，否则就进入`"terminated"`状态。**游戏进行中的异常状态，通常会导致房间进入`"terminated"`状态！**下图是一个状态转移图。

![StateTransitionDiagram](\pictures\StateTransitionDiagram.png)

房间的的属性表（如果有需要，会在后续版本继续添加项目；这部分变动会比较多，所以以实际接口返回为准）：

| 属性               | 类型   | 说明                                                         | 哪个状态下有意义 |
| ------------------ | ------ | ------------------------------------------------------------ | ---------------- |
| room_id            | Number | 房间号                                                       | all              |
| user1_id, user2_id | Number | 房间内用户情况，空值为-1                                     | all              |
| capacity           | Number | 房间容量，值为1或者2                                         | all              |
| state              | String | 房间的状态，详细说明见上                                     | all              |
| ready_users        | Array  | 房间内已经确认的用户的id                                     | full、end        |
| now_riddle_num     | Number | 现在正在答在第几题                                           | playing          |
| now_riddle_content | String | 现在正在答的题目内容                                         | playing          |
| riddle_answers     | Array  | 已经完成的题目的答案，在答题失败的时候调用<br />用来“显示正确答案”，数组内元素的类型是String | playing          |

注：在当前状态下没有意义的属性，可能不存在，也可能存在，存在时请忽略。

前端需要根据房间的属性判断出当前所在流程，比如now_riddle_num在自己没答题就变化了，就说明当前对手答了题了。如果前端在实际写项目的过程中发现有什么状态无法判断，可以QQ群沟通增加更多的房间属性。

### 3.1 创建房间(/room/create)

接口URL：/room/create

接口详细说明：  
该接口用于创建一个游戏房间，单人房用于闯关，双人房用于pk。

调用方式：POST

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明           |
| -------- | ------ | ---- | ------------------ |
| capacity | Number | 是   | 房间容量，值为1或2 |

接口返回：

| code | message                         | data            | 说明 |
| ---- | ------------------------------- | --------------- | ---- |
| 0    | success                         | room_id: Number |      |
| 1    | 调用本接口时没有带上合法的token |                 |      |
| 2    | 缺少必填参数                    |                 |      |
| 3    | 参数类型错误                    |                 |      |

### 3.2 加入房间(/room/join)

接口URL：/room/join

接口详细说明：  
该接口用于接受别人的邀请，加入一个状态为unfull的房间。房间的状态会因此变成full。

调用方式：POST

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明         |
| -------- | ------ | ---- | ---------------- |
| room_id  | Number | 是   | 要加入的房间的id |

接口返回：

| code | message                         | data | 说明 |
| ---- | ------------------------------- | ---- | ---- |
| 0    | success                         |      |      |
| 1    | 调用本接口时没有带上合法的token |      |      |
| 2    | 缺少必填参数                    |      |      |
| 3    | 参数类型错误                    |      |      |
| 200  | 无效的房间号                    |      |      |
| 210  | 房间不是unfull状态，无法加入    |      |      |

### 3.3 匹配房间(/room/match)

接口URL：/room/match

接口详细说明：  
**现在采用的是调用后阻塞式返回room_id的方法，后续版本可能视情况调整为需要主动轮询匹配结果的方式。**  
该接口用于匹配一个对手，并与之加入同一个房间内。对手的实力和自己的实力大致相似，但是不是一定相似。  
预期的实现方法是每5s进行一次，先调出所有准备进行匹配的玩家，按照“战力”的顺序存入一个有序数组，然后前30%先洗牌算法一次，后30%洗牌算法一次，中间50%洗牌算法一次（中间有交叉的区域）。然后每相邻的2个人匹配成1组。最后如果剩下一个人，那么告知其匹配失败。

调用方式：POST

调用参数：**无**

接口返回：

| code | message                         | data            | 说明              |
| ---- | ------------------------------- | --------------- | ----------------- |
| 0    | success                         | room_id: Number |                   |
| 1    | 调用本接口时没有带上合法的token |                 |                   |
| 230  | 接口不在开放时间段内            |                 |                   |
| 231  | 匹配失败                        |                 | 可以直接重试1~2次 |

### 3.4 获取房间各种属性(/room/get_attribute)

接口URL：/room/get_attribute

接口详细说明：  
本接口是游戏流程中最重要的一个接口。在游戏过程中，前端应该**每隔几秒调用它一次，根据房间的状态来执行对应的游戏逻辑**。当然，要快速得到结果时，可以1秒一次，有时只是常规看看，可以5秒1次。  
返回的data是一个对象，里面每一个字段就是一个属性，对应可以看上方“属性表”。  
本接口已经加入了“肯德基”豪华午餐：文档仅供参考，一切以实物为准(•ᴗ•)。

调用方式：POST

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明 |
| -------- | ------ | ---- | -------- |
| room_id  | Number | 是   | 房间的id |

接口返回：

| code | message                         | data       | 说明                                   |
| ---- | ------------------------------- | ---------- | -------------------------------------- |
| 0    | success                         | 一个Object | Object的各个字段见本节开头的“属性表”   |
| 1    | 调用本接口时没有带上合法的token |            |                                        |
| 2    | 缺少必填参数                    |            |                                        |
| 3    | 参数类型错误                    |            |                                        |
| 200  | 无效的房间号                    |            |                                        |
| 201  | 用户不在该房间内                |            | 用户只有在该房间内才能获得该房间的属性 |

成功返回示例：

``` JSON
{
    "code": 0,
    "message": "success",
    "data": {
        "room_id": 1000,
        "capacity": 2,
        "user1_id": 201900001111,
        "user2_id": -1,
        "state": "unfull"
    }
}
```

### 3.5 发送答题就绪信号(/room/ready)

接口URL：/room/ready

接口详细说明：  
向房间发送准备开始答题的信号，每个用户都发送了之后就会开始对战。

调用方式：POST

调用参数：**无**

接口返回：

| code | message                         | data | 说明                                   |
| ---- | ------------------------------- | ---- | -------------------------------------- |
| 0    | success                         |      | 无返回值                               |
| 1    | 调用本接口时没有带上合法的token |      |                                        |
| 200  | 无效的房间号                    |      |                                        |
| 201  | 用户不在该房间内                |      | 用户只有在该房间内才能获得该房间的属性 |

### 3.6 回答一个问题(/room/answer)

接口URL：/room/answer

接口详细说明：  
回答房间内的第num号问题。
答题接口开放时间为70秒（比要求的60秒答题时间多一点），请在指定时间内调用。用户在规定时间内没有答过题，就把ans赋值为`""`调用answer接口。**70s内不调用**会被服务器当做意外掉线处理，房间状态变为`"terminated"`。

调用方式：POST

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明       |
| -------- | ------ | ---- | -------------- |
| room_id  | Number | 是   | 房间的id       |
| num      | Number | 是   | 第几题         |
| ans      | String | 是   | 用户提供的答案 |

接口返回：

| code | message                         | data       | 说明                                   |
| ---- | ------------------------------- | ---------- | -------------------------------------- |
| 0    | success                         | 一个Object | Object的各个字段见本节开头的“属性表”   |
| 1    | 调用本接口时没有带上合法的token |            |                                        |
| 2    | 缺少必填参数                    |            |                                        |
| 3    | 参数类型错误                    |            |                                        |
| 200  | 无效的房间号                    |            |                                        |
| 201  | 用户不在该房间内                |            | 用户只有在该房间内才能回答该房间的题目 |
| 260  | 房间状态不为playing             |            |                                        |
| 261  | 当前不应该回答第num道题         |            | 见房间属性：now_riddle_num。           |

### 3.7 离开房间(/room/leave)

接口URL：/room/leave

接口详细说明：  
用户主动离开房间，可以调用该接口，房间的状态会因此变为terminated。

调用方式：POST

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明 |
| -------- | ------ | ---- | -------- |
| room_id  | Number | 是   | 房间的id |

接口返回：

| code | message                         | data                | 说明                             |
| ---- | ------------------------------- | ------------------- | -------------------------------- |
| 0    | success                         | is_correct: boolean |                                  |
| 1    | 调用本接口时没有带上合法的token |                     |                                  |
| 2    | 缺少必填参数                    |                     |                                  |
| 3    | 参数类型错误                    |                     |                                  |
| 200  | 无效的房间号                    |                     |                                  |
| 201  | 用户不在该房间内                |                     | 用户只有在该房间内才能离开该房间 |
| 270  | 房间状态已经是terminated        |                     |                                  |


## 4. 个人信息获取模块

### 4.1 获取高分榜(/info/ranking_list)

接口URL：/info/ranking_list

接口详细说明：  
获取得分高分榜。  
只提供第1-100名的数据，offset和limit没设好会导致返回的数组为空(empty)。

调用方式：GET

调用参数：

| 参数名称 | 类型   | 必填 | 参数说明                                      |
| -------- | ------ | ---- | --------------------------------------------- |
| offset   | Number | 否   | 从第几项开始（不含），默认为0，即1、2、3、... |
| limit    | Number | 否   | 榜单长度，默认为10。                          |

接口返回：

| code | message                         | data  | 说明                           |
| ---- | ------------------------------- | ----- | ------------------------------ |
| 0    | success                         | Array | Array里的元素为{userid, score} |
| 1    | 调用本接口时没有带上合法的token |       |                                |
| 3    | 参数类型错误                    |       |                                |

成功返回示例：

``` JSON
{
	"code": 0,
	"message": "success",
	"data": [
        {
			"user_id": 201900001111,
			"score": 131
		},
		{
			"user_id": 202000001111,
			"score": 130
		}
	]
}
```